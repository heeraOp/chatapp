{% extends "chat/base.html" %}

{% block title %}Room: {{ room }}{% endblock %}

{% block content %}
<div class="chat-card">

    <div class="chat-header">
        Room: <strong>{{ room }}</strong>
    </div>

    <!-- User identity -->
    <div class="user-info">
        <input id="username-input" type="text" placeholder="Your name" />
        <input id="phone-input" type="text" placeholder="Phone number (identity only)" />
    </div>

    <!-- Messages -->
    <div id="chat-log" class="chat-log"></div>

    <!-- Input -->
    <div class="chat-input">
        <input id="message-input" type="text" placeholder="Type a message..." />
        <button id="send-btn">Send</button>
    </div>

</div>

<script>
(function () {
    const roomName = "{{ room|escapejs }}";

    const chatLog = document.getElementById("chat-log");
    const messageInput = document.getElementById("message-input");
    const usernameInput = document.getElementById("username-input");
    const phoneInput = document.getElementById("phone-input");
    const sendBtn = document.getElementById("send-btn");

    /* ðŸ” FORCE WSS ON HTTPS (RENDER FIX) */
    const wsScheme = window.location.protocol === "https:" ? "wss://" : "ws://";
    const wsUrl = wsScheme + window.location.host + "/ws/chat/" + roomName + "/";

    console.log("ðŸ“¡ WebSocket URL:", wsUrl);

    let socket = new WebSocket(wsUrl);

    socket.onopen = () => {
        console.log("âœ… WebSocket connected");
    };

    socket.onclose = () => {
        console.warn("âš ï¸ WebSocket closed");
    };

    socket.onerror = (err) => {
        console.error("âŒ WebSocket error", err);
    };

    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        const msg = document.createElement("div");
        msg.classList.add("message");

        msg.innerHTML = `
            <div class="msg-header">
                <span class="msg-username">${data.username}</span>
                <span class="msg-time">${data.timestamp}</span>
            </div>
            <div class="msg-body">${data.message}</div>
        `;

        chatLog.appendChild(msg);
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    function sendMessage() {
        if (!usernameInput.value.trim() ||
            !phoneInput.value.trim() ||
            !messageInput.value.trim()
        ) {
            alert("Username, phone number, and message are required.");
            return;
        }

        /* ðŸ›‘ PREVENT CLOSED SOCKET SEND */
        if (socket.readyState !== WebSocket.OPEN) {
            alert("Connection lost. Please refresh the page.");
            return;
        }

        socket.send(JSON.stringify({
            username: usernameInput.value,
            phone: phoneInput.value,
            message: messageInput.value
        }));

        messageInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);

    messageInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") sendMessage();
    });
})();
</script>
{% endblock %}
